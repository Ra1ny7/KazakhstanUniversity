{% extends "base.html" %}
{% block title %}–ü–æ–º–æ—â–Ω–∏–∫{% endblock %}
{% block page_title %}–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫{% endblock %}
{% block page_sub %}–ü–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–±–æ—Ä—É —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é{% endblock %}

{% block content %}
<style>
/* ===== –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ===== */
.assistant-container { max-width: 900px; margin: 0 auto; padding: 20px; }

/* ===== –ß–∞—Ç ===== */
.chatbot-container {
    background: linear-gradient(145deg, #f0fdf4, #e8f5e9);
    border-radius: 20px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    padding: 20px;
    display: flex;
    flex-direction: column;
}

.chatbot-header {
    font-weight: 700;
    font-size: 1.2rem;
    color: #1b5e20;
    margin-bottom: 16px;
}

.chatbot-messages {
    flex: 1;
    max-height: 400px;
    overflow-y: auto;
    background: #ffffff;
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid #d0d0d0;
    scroll-behavior: smooth;
}

.chatbot-message {
    display: inline-block;
    margin: 6px 0;
    padding: 10px 14px;
    border-radius: 16px;
    max-width: 75%;
    word-wrap: break-word;
    font-size: 0.95rem;
    line-height: 1.4;
    animation: fadeIn 0.3s ease forwards;
}

.chatbot-message.user {
    background: #1b5e20;
    color: #fff;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

.chatbot-message.bot {
    background: #d9f0e1;
    color: #1b5e20;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}

/* ===== –í–≤–æ–¥ ===== */
.chatbot-input-container {
    display: flex;
    gap: 10px;
    margin-top: 8px;
}

.chatbot-input-container input {
    flex: 1;
    padding: 12px 16px;
    border-radius: 20px;
    border: 1px solid #c0c0c0;
    outline: none;
    font-size: 0.95rem;
    transition: all 0.2s ease;
}

.chatbot-input-container input:focus {
    border-color: #1b5e20;
    box-shadow: 0 0 0 2px rgba(27, 94, 32, 0.2);
}

.chatbot-input-container button {
    background: #1b5e20;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
}

.chatbot-input-container button:hover {
    background: #145a18;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* ===== –ê–Ω–∏–º–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π ===== */
@keyframes fadeIn {
    0% { opacity: 0; transform: translateY(10px); }
    100% { opacity: 1; transform: translateY(0); }
}

/* ===== –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ ===== */
.chatbot-messages::-webkit-scrollbar {
    width: 8px;
}
.chatbot-messages::-webkit-scrollbar-thumb {
    background-color: #a5d6a7;
    border-radius: 4px;
}
.chatbot-messages::-webkit-scrollbar-track {
    background: #f0fdf4;
}

/* ===== –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –∏ —Å–æ–≤–µ—Ç—ã ===== */
.university-list { display: grid; gap: 16px; }
.university-item {
    background: #fff;
    padding: 20px;
    border-radius: 16px;
    border-left: 4px solid #1b5e20;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}
.university-item:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
.university-name { font-weight: 600; color: #145a18; font-size: 1.1rem; }
.university-city { color: #555; font-size: 0.9rem; margin-top: 4px; }
.btn { background: #1b5e20; color: white; border: none; padding: 12px 20px; border-radius: 16px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.2s ease; }
.btn:hover { background: #145a18; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

</style>

<div class="assistant-container">
    <div class="chatbot-container" id="chatbotContainer">
        <div class="chatbot-header">üí¨ –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (—á–∞—Ç)</div>
        <div class="chatbot-messages" id="chatbotMessages"></div>
        <div class="chatbot-input-container">
            <input type="text" id="chatbotInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å..." />
            <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div class="card" style="margin-top:30px;">
        <h3 style="margin-bottom:20px; color: #1b5e20;">üìã –°–ø–∏—Å–æ–∫ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–≤</h3>
        <div class="university-list">
            {% for u in universities %}
            <div class="university-item">
                <div>
                    <div class="university-name">{{ u.name }}</div>
                    <div class="university-city">üìç {{ u.city }}</div>
                </div>
                <button class="btn" onclick='showAdvice({{ u|tojson }}, this)'>üí° –ü–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç—ã</button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div id="adviceModal" class="advice-modal" aria-hidden="true">
    <div class="advice-content">
        <span class="close" onclick="closeAdvice()">&times;</span>
        <h2 id="advice-title" style="color: #1b5e20; margin-bottom:24px;"></h2>
        <div id="advice-body"></div>
    </div>
</div>

<script>
let messages = [];
let lastButton = null;

function toggleAdvice(el) { el.closest('.advice-section').classList.toggle('active'); }

function showAdvice(university, buttonEl) {
    lastButton = buttonEl;
    document.getElementById('advice-title').textContent = "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: " + university.name;
    const html = `
        <div class="advice-section active">
            <div class="advice-section-header" onclick="toggleAdvice(this)"><h4>üìù –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—é</h4><span class="toggle-icon">‚ñ∂</span></div>
            <div class="advice-section-content"><ul>
                <li>–ù–∞—á–Ω–∏—Ç–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –∑–∞ 6‚Äì12 –º–µ—Å—è—Ü–µ–≤.</li>
                <li>–ò–∑—É—á–∏—Ç–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ï–ù–¢/–ö–¢ –∏ IELTS/TOEFL.</li>
                <li>–ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ.</li>
                <li>–°–æ–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Ç —É—á–∏—Ç–µ–ª–µ–π.</li>
            </ul></div>
        </div>
        <div class="advice-section">
            <div class="advice-section-header" onclick="toggleAdvice(this)"><h4>üí∞ –§–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ</h4><span class="toggle-icon">‚ñ∂</span></div>
            <div class="advice-section-content"><ul>
                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥—Ä–∞–Ω—Ç—ã –∏ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏.</li>
                <li>–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã.</li>
                <li>–£–∑–Ω–∞–π—Ç–µ –ø—Ä–æ –ø–æ–¥—Ä–∞–±–æ—Ç–∫—É –≤ –≥–æ—Ä–æ–¥–µ ${university.city}.</li>
                <li>–°–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ.</li>
            </ul></div>
        </div>
        <div class="advice-section">
            <div class="advice-section-header" onclick="toggleAdvice(this)"><h4>üìö –í—ã–±–æ—Ä –ø—Ä–æ–≥—Ä–∞–º–º—ã</h4><span class="toggle-icon">‚ñ∂</span></div>
            <div class="advice-section-content"><ul>
                <li>–ò–∑—É—á–∏—Ç–µ —É—á–µ–±–Ω—ã–µ –ø–ª–∞–Ω—ã.</li>
                <li>–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π.</li>
                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã.</li>
                <li>–ü–æ—Å–µ—Ç–∏—Ç–µ –î–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–≤–µ—Ä–µ–π.</li>
            </ul></div>
        </div>
        <div class="advice-section">
            <div class="advice-section-header" onclick="toggleAdvice(this)"><h4>üéØ –ö–∞—Ä—å–µ—Ä–Ω—ã–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã</h4><span class="toggle-icon">‚ñ∂</span></div>
            <div class="advice-section-content"><ul>
                <li>–ò–∑—É—á–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</li>
                <li>–£–∑–Ω–∞–π—Ç–µ –æ —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–∞—Ö.</li>
                <li>–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞—É—á–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã.</li>
                <li>–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏–∏-–ø–∞—Ä—Ç–Ω—ë—Ä—ã.</li>
            </ul></div>
        </div>`;
    document.getElementById("advice-body").innerHTML = html;
    document.getElementById("adviceModal").style.display = "block";
    document.getElementById("adviceModal").setAttribute("aria-hidden", "false");
}

function closeAdvice() {
    document.getElementById("adviceModal").style.display = "none";
    document.getElementById("adviceModal").setAttribute("aria-hidden", "true");
    if (lastButton) lastButton.focus();
}

window.onclick = function(event) {
    if (event.target === document.getElementById("adviceModal")) closeAdvice();
}

async function sendMessage() {
    const inputEl = document.getElementById("chatbotInput");
    const text = inputEl.value.trim();
    if (!text) return;
    addMessage("user", text);
    inputEl.value = "";

    try {
        const response = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                messages: [...messages, { role: "user", content: text }],
                universities_context: JSON.stringify({{ universities|tojson }})
            })
        });
        const data = await response.json();
        if (data.success) {
            addMessage("bot", data.reply);
            messages.push({ role: "user", content: text });
            messages.push({ role: "assistant", content: data.reply });
        } else {
            addMessage("bot", "‚ö† –û—à–∏–±–∫–∞: " + data.reply);
        }
    } catch (e) {
        addMessage("bot", "‚ö† –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
        console.error(e);
    }
}

function addMessage(role, text) {
    const msgEl = document.createElement("div");
    msgEl.classList.add("chatbot-message", role);
    msgEl.innerHTML = text.replace(/\n/g, "<br>");
    const container = document.getElementById("chatbotMessages");
    container.appendChild(msgEl);
    container.scrollTop = container.scrollHeight;
}
</script>
{% endblock %}
